# Constitutional Hash: cdd01ef066bc6cf2
# ACGS Production PostgreSQL Client Authentication Configuration (pg_hba.conf)
# Security-hardened authentication for multi-tenant architecture
#
# Database administrative login by Unix domain socket
local   all             postgres                                peer

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     peer

# IPv4 local connections:
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             ::1/128                 scram-sha-256

# Docker network connections (acgs-database network: 172.22.0.0/24)
host    all             all             172.22.0.0/24           scram-sha-256

# ACGS Service-specific database access
# Authentication Service
host    acgs_auth       acgs_auth       172.22.0.0/24           scram-sha-256

# Constitutional AI Service
host    acgs_constitutional acgs_constitutional 172.22.0.0/24   scram-sha-256

# Integrity Service
host    acgs_integrity  acgs_integrity  172.22.0.0/24           scram-sha-256

# Policy Governance Service
host    acgs_policy     acgs_policy     172.22.0.0/24           scram-sha-256

# Governance Synthesis Service
host    acgs_synthesis  acgs_synthesis  172.22.0.0/24           scram-sha-256

# Monitoring connections (from backend network: 172.21.0.0/24)
host    postgres        postgres        172.21.0.0/24           scram-sha-256

# Replication connections
# Allow replication connections from trusted hosts
host    replication     replicator      172.22.0.0/24           scram-sha-256

# Constitutional compliance: Log all authentication attempts
# This is configured in postgresql.conf with log_connections = on

# Security notes:
# 1. All connections require scram-sha-256 authentication (strongest available)
# 2. No trust or md5 authentication methods are used
# 3. Connections are restricted to specific network ranges
# 4. Each service has its own database user with limited privileges
# 5. SSL is required for all TCP connections (configured in postgresql.conf)

# Multi-tenant security:
# Each tenant's data is isolated using Row Level Security (RLS) policies
# Service users have access only to their respective databases
# Cross-service access is controlled through specific grants

# Deny all other connections
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject
