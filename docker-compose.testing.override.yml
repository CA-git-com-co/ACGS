version: '3.8'

# ACGS Testing Environment Overrides
# Constitutional Hash: cdd01ef066bc6cf2
#
# Testing-specific configurations for automated testing pipelines.
# Use with: docker-compose -f docker-compose.base.yml -f docker-compose.services.yml -f docker-compose.testing.override.yml up

services:
  # Testing PostgreSQL with isolated database
  postgres:
    environment:
      POSTGRES_PASSWORD: acgs_test_password
      POSTGRES_DB: acgs_test
      CONSTITUTIONAL_HASH: cdd01ef066bc6cf2
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./infrastructure/database/init:/docker-entrypoint-initdb.d
      - ./tests/fixtures/sql:/test-fixtures
    command: postgres -c fsync=off -c synchronous_commit=off -c full_page_writes=off

  # Testing Redis with ephemeral data
  redis:
    environment:
      REDIS_PASSWORD: acgs_test_redis
      CONSTITUTIONAL_HASH: cdd01ef066bc6cf2
    volumes:
      - redis_test_data:/data
    command: redis-server --appendonly no --save "" --requirepass acgs_test_redis

  # Testing Constitutional AI with test configuration
  constitutional-ai:
    environment:
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/0
      - OPA_URL=http://opa:8181
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=constitutional-ai
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - ./services/core/constitutional-ai:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro
    command: python -m pytest tests/ -v --tb=short

  # Testing Integrity Service with test configuration
  integrity:
    environment:
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/1
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=integrity
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - ./services/platform_services/integrity:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro

  # Testing API Gateway with test configuration
  api-gateway:
    environment:
      - CONSTITUTIONAL_AI_URL=http://constitutional-ai:8000
      - INTEGRITY_URL=http://integrity:8000
      - GOVERNANCE_SYNTHESIS_URL=http://governance-synthesis:8000
      - AUTH_URL=http://auth:8000
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/2
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=api-gateway
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - RATE_LIMIT_PER_MINUTE=10000  # High for testing
      - PYTHONPATH=/app
    volumes:
      - ./services/platform_services/api_gateway:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro

  # Testing Governance Synthesis with test configuration
  governance-synthesis:
    environment:
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/3
      - OPA_URL=http://opa:8181
      - NATS_URL=nats://nats:4222
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=governance-synthesis
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - ./services/core/governance-synthesis:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro

  # Testing Authentication with test configuration
  auth:
    environment:
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/4
      - SECRET_KEY=test-secret-key-32-chars-long-minimum
      - JWT_SECRET_KEY=test-jwt-secret-key-64-chars-long-for-testing-only-use
      - CSRF_SECRET_KEY=test-csrf-secret-key-32-chars-long
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=auth
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - ACCESS_TOKEN_EXPIRE_MINUTES=5  # Short for testing
      - REFRESH_TOKEN_EXPIRE_DAYS=1   # Short for testing
      - PYTHONPATH=/app
    volumes:
      - ./services/platform_services/authentication:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro

  # Testing Code Analysis with test configuration
  code-analysis:
    environment:
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/5
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=code-analysis
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - ./services/core/code-analysis:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro

  # Testing Context Service with test configuration
  context:
    environment:
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/6
      - NATS_URL=nats://nats:4222
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - SERVICE_NAME=context
      - ENVIRONMENT=testing
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - ./services/core/context:/app:delegated
      - ./services/shared:/app/services/shared:delegated
      - ./tests:/app/tests:ro

  # Test Runner container for orchestrating tests
  test-runner:
    image: python:3.11-slim
    container_name: acgs_test_runner
    volumes:
      - .:/workspace:delegated
      - test_runner_cache:/root/.cache
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - DATABASE_URL=postgresql://acgs_user:acgs_test_password@postgres:5432/acgs_test
      - REDIS_URL=redis://:acgs_test_redis@redis:6379/0
      - TESTING=true
    command: |
      bash -c "
        pip install -r requirements.txt &&
        python -m pytest tests/ -v --tb=short --cov=services --cov-report=html --cov-report=term &&
        python -m pytest tests/integration/ -v --tb=short
      "
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opa:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - acgs_network
    labels:
      - "acgs.service=testing"
      - "acgs.component=test-runner"
      - "acgs.constitutional_hash=cdd01ef066bc6cf2"

  # Load Testing container
  load-tester:
    image: python:3.11-slim
    container_name: acgs_load_tester
    volumes:
      - ./tests/load_testing:/workspace:delegated
      - load_test_cache:/root/.cache
    working_dir: /workspace
    environment:
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - API_GATEWAY_URL=http://api-gateway:8000
      - CONSTITUTIONAL_AI_URL=http://constitutional-ai:8000
    command: |
      bash -c "
        pip install locust requests &&
        locust -f load_test.py --headless -u 100 -r 10 -t 60s --host=http://api-gateway:8000
      "
    depends_on:
      api-gateway:
        condition: service_healthy
      constitutional-ai:
        condition: service_healthy
    networks:
      - acgs_network
    labels:
      - "acgs.service=testing"
      - "acgs.component=load-testing"
      - "acgs.constitutional_hash=cdd01ef066bc6cf2"

# Testing volumes (ephemeral for CI/CD)
volumes:
  postgres_test_data:
    driver: local
    labels:
      - "acgs.volume=database"
      - "acgs.environment=testing"
      - "acgs.constitutional_hash=cdd01ef066bc6cf2"
  
  redis_test_data:
    driver: local
    labels:
      - "acgs.volume=cache"
      - "acgs.environment=testing"
      - "acgs.constitutional_hash=cdd01ef066bc6cf2"
  
  test_runner_cache:
    driver: local
    labels:
      - "acgs.volume=cache"
      - "acgs.environment=testing"
      - "acgs.constitutional_hash=cdd01ef066bc6cf2"
  
  load_test_cache:
    driver: local
    labels:
      - "acgs.volume=cache"
      - "acgs.environment=testing"
      - "acgs.constitutional_hash=cdd01ef066bc6cf2"