apiVersion: apps/v1
kind: Deployment
metadata:
  name: qec-sft-service
  namespace: acgs-pgp-v8
  labels:
    app: qec-sft-service
    component: semantic-fault-tolerance
    version: v8.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: qec-sft-service
  template:
    metadata:
      labels:
        app: qec-sft-service
        component: semantic-fault-tolerance
        version: v8.0.0
    spec:
      containers:
        - name: qec-sft-service
          image: acgs/qec-sft-service:latest
          ports:
            - containerPort: 8010
              name: http
          env:
            - name: LOG_LEVEL
              value: 'INFO'
            - name: STABILIZER_REGISTRY_PATH
              value: '/app/stabilizers'
            - name: MAX_CONCURRENT_STABILIZERS
              value: '10'
            - name: CONSTITUTIONAL_HASH
              value: 'cdd01ef066bc6cf2'
            - name: REDIS_URL
              value: 'redis://redis-service:6379/0'
            - name: POSTGRES_URL
              value: 'postgresql://acgs_user:acgs_password@postgres-service:5432/acgs_db'
            - name: RESPONSE_TIME_TARGET_MS
              value: '500'
            - name: ENABLE_CIRCUIT_BREAKER
              value: 'true'
          volumeMounts:
            - name: config-volume
              mountPath: /app/config
            - name: stabilizers-volume
              mountPath: /app/stabilizers
            - name: schemas-volume
              mountPath: /app/schemas
          resources:
            limits:
              cpu: '2'
              memory: '4Gi'
            requests:
              cpu: '1'
              memory: '2Gi'
          livenessProbe:
            httpGet:
              path: /health
              port: 8010
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8010
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      volumes:
        - name: config-volume
          configMap:
            name: qec-sft-config
        - name: stabilizers-volume
          persistentVolumeClaim:
            claimName: stabilizers-pvc
        - name: schemas-volume
          configMap:
            name: qec-sft-schemas
      serviceAccountName: qec-sft-service-account
      securityContext:
        fsGroup: 1000
---
apiVersion: v1
kind: Service
metadata:
  name: qec-sft-service
  namespace: acgs-pgp-v8
  labels:
    app: qec-sft-service
    component: semantic-fault-tolerance
spec:
  selector:
    app: qec-sft-service
  ports:
    - port: 80
      targetPort: 8010
      protocol: TCP
      name: http
  type: ClusterIP
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: qec-sft-config
  namespace: acgs-pgp-v8
data:
  config.yaml: |
    service:
      name: "qec-sft-service"
      version: "8.0.0"
      port: 8010
      host: "0.0.0.0"

    constitutional:
      hash: "cdd01ef066bc6cf2"
      compliance_threshold: 0.8
      validation_enabled: true
      enforcement_mode: "strict"

    stabilizer_execution:
      max_concurrent_executions: 10
      default_timeout_seconds: 60
      memory_limit_mb: 512
      cpu_limit: 1.0
      enable_circuit_breaker: true
      circuit_breaker_threshold: 3
      circuit_breaker_timeout: 30

    syndrome_diagnostic:
      enable_ml_models: true
      error_classification_threshold: 0.7
      auto_recovery_enabled: true
      diagnostic_timeout_seconds: 30

    performance:
      response_time_target_ms: 500
      max_memory_usage_mb: 2048
      max_cpu_usage_percent: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: qec-sft-schemas
  namespace: acgs-pgp-v8
data:
  logical_semantic_unit.json: |
    {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Logical Semantic Unit",
      "type": "object",
      "required": ["id", "description", "domain", "constraints"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^LSU-[0-9]{6}$"
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "maxLength": 500
        },
        "domain": {
          "type": "string",
          "enum": ["governance", "policy", "security", "compliance", "operations"]
        },
        "constraints": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["type", "value"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["temporal", "logical", "security", "performance"]
              },
              "value": {
                "type": "string"
              }
            }
          }
        }
      }
    }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: stabilizers-pvc
  namespace: acgs-pgp-v8
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: qec-sft-service-account
  namespace: acgs-pgp-v8
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: acgs-pgp-v8
  name: qec-sft-role
rules:
  - apiGroups: ['']
    resources: ['configmaps', 'secrets']
    verbs: ['get', 'list', 'watch']
  - apiGroups: ['']
    resources: ['pods']
    verbs: ['get', 'list', 'watch', 'create', 'delete']
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: qec-sft-rolebinding
  namespace: acgs-pgp-v8
subjects:
  - kind: ServiceAccount
    name: qec-sft-service-account
    namespace: acgs-pgp-v8
roleRef:
  kind: Role
  name: qec-sft-role
  apiGroup: rbac.authorization.k8s.io
