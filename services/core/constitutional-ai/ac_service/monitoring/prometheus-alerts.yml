# Enhanced Constitutional Governance Framework - Prometheus Alerting Rules
# Constitutional Hash: cdd01ef066bc6cf2

groups:
  - name: governance_framework_alerts
    rules:
      # High Latency Alert (>200ms as specified)
      - alert: GovernanceHighLatency
        expr: governance_latency_seconds{quantile="0.99"} > 0.2
        for: 1m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "High governance latency detected"
          description: "P99 governance latency is {{ $value }}s, exceeding 200ms threshold for 1 minute"
          runbook_url: "https://acgs-2.docs/runbooks/governance-latency"
          
      # Critical Latency Alert (>1s)
      - alert: GovernanceCriticalLatency
        expr: governance_latency_seconds{quantile="0.99"} > 1.0
        for: 30s
        labels:
          severity: critical
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Critical governance latency detected"
          description: "P99 governance latency is {{ $value }}s, exceeding 1s critical threshold"
          runbook_url: "https://acgs-2.docs/runbooks/governance-critical-latency"
          
      # Low Confidence Alert
      - alert: GovernanceLowConfidence
        expr: governance_confidence < 0.6
        for: 2m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Low governance confidence detected"
          description: "Governance confidence is {{ $value }}, below 0.6 threshold for 2 minutes"
          runbook_url: "https://acgs-2.docs/runbooks/governance-confidence"
          
      # Constitutional Compliance Alert
      - alert: GovernanceComplianceViolation
        expr: governance_compliance_rate < 0.95
        for: 1m
        labels:
          severity: critical
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Constitutional compliance violation detected"
          description: "Governance compliance rate is {{ $value }}, below 95% threshold"
          runbook_url: "https://acgs-2.docs/runbooks/constitutional-compliance"
          
      # High Error Rate Alert
      - alert: GovernanceHighErrorRate
        expr: rate(governance_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "High governance error rate detected"
          description: "Governance error rate is {{ $value }} errors/sec over 5 minutes"
          runbook_url: "https://acgs-2.docs/runbooks/governance-errors"
          
      # Service Down Alert
      - alert: GovernanceServiceDown
        expr: up{job="constitutional_governance"} == 0
        for: 30s
        labels:
          severity: critical
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Governance service is down"
          description: "Constitutional governance service has been down for 30 seconds"
          runbook_url: "https://acgs-2.docs/runbooks/service-down"
          
      # Memory Usage Alert
      - alert: GovernanceHighMemoryUsage
        expr: process_resident_memory_bytes{job="constitutional_governance"} > 1e9
        for: 5m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "High memory usage in governance service"
          description: "Governance service memory usage is {{ $value | humanize }}B"
          runbook_url: "https://acgs-2.docs/runbooks/memory-usage"
          
      # Rate Limiting Alert
      - alert: GovernanceRateLimitHit
        expr: increase(governance_errors_total{error_type="rate_limit"}[5m]) > 10
        for: 1m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Governance rate limiting triggered frequently"
          description: "{{ $value }} rate limit violations in the last 5 minutes"
          runbook_url: "https://acgs-2.docs/runbooks/rate-limiting"

  - name: governance_domain_alerts
    rules:
      # Healthcare Domain Alerts
      - alert: HealthcareComplianceIssue
        expr: governance_requests_total{domain="healthcare",result="violate"} > 0
        for: 1m
        labels:
          severity: critical
          service: constitutional_governance
          domain: healthcare
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Healthcare governance compliance violation"
          description: "Healthcare domain governance violation detected - HIPAA compliance at risk"
          runbook_url: "https://acgs-2.docs/runbooks/healthcare-compliance"
          
      # Finance Domain Alerts  
      - alert: FinanceComplianceIssue
        expr: governance_requests_total{domain="finance",result="violate"} > 0
        for: 1m
        labels:
          severity: critical
          service: constitutional_governance
          domain: finance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Finance governance compliance violation"
          description: "Finance domain governance violation detected - KYC/AML compliance at risk"
          runbook_url: "https://acgs-2.docs/runbooks/finance-compliance"
          
      # Research Domain Alerts
      - alert: ResearchComplianceIssue
        expr: governance_requests_total{domain="research",result="violate"} > 0
        for: 1m
        labels:
          severity: high
          service: constitutional_governance
          domain: research
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Research governance compliance violation"
          description: "Research domain governance violation detected - IRB compliance at risk"
          runbook_url: "https://acgs-2.docs/runbooks/research-compliance"

  - name: governance_performance_alerts
    rules:
      # Throughput Alert
      - alert: GovernanceLowThroughput
        expr: rate(governance_requests_total[5m]) < 10
        for: 5m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Low governance throughput detected"
          description: "Governance throughput is {{ $value }} requests/sec, below 10 RPS threshold"
          runbook_url: "https://acgs-2.docs/runbooks/throughput"
          
      # Cache Performance Alert
      - alert: GovernanceLowCacheHitRate
        expr: |
          (
            rate(governance_requests_total[5m]) - 
            rate(governance_cache_misses_total[5m])
          ) / rate(governance_requests_total[5m]) < 0.85
        for: 10m
        labels:
          severity: warning
          service: constitutional_governance
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Low governance cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}, below 85% threshold"
          runbook_url: "https://acgs-2.docs/runbooks/cache-performance"

  - name: governance_security_alerts
    rules:
      # Constitutional Hash Mismatch Alert
      - alert: ConstitutionalHashMismatch
        expr: |
          governance_requests_total{constitutional_hash!="cdd01ef066bc6cf2"} > 0
        for: 1m
        labels:
          severity: critical
          service: constitutional_governance
          security: constitutional_integrity
        annotations:
          summary: "Constitutional hash mismatch detected"
          description: "Governance request with invalid constitutional hash detected"
          runbook_url: "https://acgs-2.docs/runbooks/constitutional-integrity"
          
      # Suspicious Activity Alert
      - alert: GovernanceSuspiciousActivity
        expr: |
          rate(governance_errors_total{error_type="validation"}[5m]) > 1
        for: 2m
        labels:
          severity: high
          service: constitutional_governance
          security: suspicious_activity
          constitutional_hash: cdd01ef066bc6cf2
        annotations:
          summary: "Suspicious governance activity detected"
          description: "High rate of validation errors: {{ $value }} errors/sec"
          runbook_url: "https://acgs-2.docs/runbooks/suspicious-activity"

# AlertManager routing configuration
route:
  group_by: ['alertname', 'service', 'constitutional_hash']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'governance-alerts'
  routes:
    - match:
        severity: critical
      receiver: 'governance-critical'
      group_wait: 5s
      repeat_interval: 15m
    - match:
        domain: healthcare
      receiver: 'healthcare-compliance'
      group_wait: 5s
      repeat_interval: 30m
    - match:
        domain: finance
      receiver: 'finance-compliance'
      group_wait: 5s
      repeat_interval: 30m

receivers:
  - name: 'governance-alerts'
    webhook_configs:
      - url: 'http://acgs-alerting:8080/webhook/governance'
        send_resolved: true
        
  - name: 'governance-critical'
    webhook_configs:
      - url: 'http://acgs-alerting:8080/webhook/critical'
        send_resolved: true
    pagerduty_configs:
      - service_key: 'GOVERNANCE_PAGERDUTY_KEY'
        description: 'Critical governance alert: {{ .GroupLabels.alertname }}'
        
  - name: 'healthcare-compliance'
    webhook_configs:
      - url: 'http://acgs-alerting:8080/webhook/healthcare'
        send_resolved: true
    email_configs:
      - to: 'healthcare-compliance@acgs-2.org'
        subject: 'HIPAA Compliance Alert: {{ .GroupLabels.alertname }}'
        
  - name: 'finance-compliance'
    webhook_configs:
      - url: 'http://acgs-alerting:8080/webhook/finance'
        send_resolved: true
    email_configs:
      - to: 'finance-compliance@acgs-2.org'
        subject: 'KYC/AML Compliance Alert: {{ .GroupLabels.alertname }}'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'constitutional_hash']
