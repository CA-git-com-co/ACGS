groups:
  - name: api_deprecation_alerts
    rules:
      - alert: DeprecatedEndpointHighUsage
        annotations:
          description: Deprecated endpoint {{$labels.endpoint}} in version {{$labels.version}}
            is receiving {{$value}} requests/second
          summary: High usage of deprecated endpoint {{$labels.endpoint}} in version {{$labels.version}}
        expr: sum by (endpoint, version) (rate(api_deprecated_endpoint_usage_total[5m]))
          > 10
        for: 5m
        labels:
          severity: warning
          team: api
      - alert: SunsetDateApproaching
        annotations:
          description: Deprecated endpoint will be sunset in less than 30 days
          summary: API endpoint sunset date approaching in 30 days
        expr: time() > on() (api_deprecated_endpoint_sunset_timestamp - 86400 * 30)
        for: 1h
        labels:
          severity: critical
          team: api
  - name: api_sla_alerts
    rules:
      - alert: APIResponseTimeSLABreach
        annotations:
          description: 95th percentile response time for version {{$labels.version}} is
            {{$value}}s, exceeding 100ms SLA
          summary: API response time SLA breach for version {{$labels.version}}
        expr: histogram_quantile(0.95, sum(rate(api_version_response_duration_seconds_bucket[5m]))
          by (version, le)) > 0.1
        for: 2m
        labels:
          severity: warning
          team: api
      - alert: APIErrorRateHigh
        annotations:
          description: Error rate for version {{$labels.version}} is {{$value | humanizePercentage}}
          summary: High error rate for API version {{$labels.version}}
        expr: sum by (version) (rate(api_version_requests_total{status_code=~"5.."}[5m]))
          / sum by (version) (rate(api_version_requests_total[5m])) > 0.01
        for: 1m
        labels:
          severity: critical
          team: api
