# ACGS Kimi-Dev-72B Prometheus Monitoring Configuration
# Integrates with existing ACGS monitoring infrastructure

global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "kimi-alerts.yml"

scrape_configs:
  # Kimi Service Metrics
  - job_name: 'kimi-service'
    static_configs:
      - targets: ['localhost:9007']
    metrics_path: '/metrics'
    scrape_interval: 10s
    scrape_timeout: 5s
    honor_labels: true
    params:
      format: ['prometheus']
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: localhost:9007
      - target_label: service
        replacement: kimi-dev-72b
      - target_label: environment
        replacement: ${ENVIRONMENT:-development}

  # Kimi Node Exporter (System Metrics)
  - job_name: 'kimi-node-exporter'
    static_configs:
      - targets: ['localhost:9008']
    metrics_path: '/metrics'
    scrape_interval: 15s
    relabel_configs:
      - target_label: service
        replacement: kimi-node-exporter
      - target_label: environment
        replacement: ${ENVIRONMENT:-development}

  # GPU Metrics (if nvidia-ml-py is available)
  - job_name: 'kimi-gpu-metrics'
    static_configs:
      - targets: ['localhost:9009']
    metrics_path: '/gpu-metrics'
    scrape_interval: 10s
    scrape_timeout: 5s
    honor_labels: true
    relabel_configs:
      - target_label: service
        replacement: kimi-gpu-monitor
      - target_label: environment
        replacement: ${ENVIRONMENT:-development}

  # vLLM Internal Metrics
  - job_name: 'vllm-metrics'
    static_configs:
      - targets: ['localhost:8007']
    metrics_path: '/metrics'
    scrape_interval: 15s
    params:
      format: ['prometheus']
    relabel_configs:
      - target_label: service
        replacement: vllm-engine
      - target_label: model
        replacement: kimi-dev-72b
      - target_label: environment
        replacement: ${ENVIRONMENT:-development}

  # Custom Application Metrics
  - job_name: 'kimi-app-metrics'
    static_configs:
      - targets: ['localhost:8007']
    metrics_path: '/app-metrics'
    scrape_interval: 30s
    honor_labels: true
    metric_relabel_configs:
      # Rename metrics to follow ACGS naming convention
      - source_labels: [__name__]
        regex: 'vllm_(.*)'
        target_label: __name__
        replacement: 'acgs_kimi_${1}'
      - source_labels: [__name__]
        regex: 'http_(.*)'
        target_label: __name__
        replacement: 'acgs_kimi_http_${1}'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Remote write configuration (for long-term storage)
remote_write:
  - url: "http://prometheus:9090/api/v1/write"
    queue_config:
      max_samples_per_send: 1000
      max_shards: 200
      capacity: 2500
