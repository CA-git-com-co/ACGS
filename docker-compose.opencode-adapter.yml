version: '3.8'

services:
  opencode-adapter:
    build:
      context: ./services/cli/opencode_adapter
      dockerfile: Dockerfile
    container_name: acgs-opencode-adapter
    ports:
      - "8020:8020"
    environment:
      # ACGS Service Configuration
      - ACGS_AUTH_SERVICE_URL=http://auth-service:8016
      - ACGS_POLICY_SERVICE_URL=http://policy-service:8002
      - ACGS_AUDIT_SERVICE_URL=http://audit-service:8004
      - ACGS_HITL_SERVICE_URL=http://hitl-service:8006
      
      # Agent Credentials
      - ACGS_AGENT_ID=${OPENCODE_AGENT_ID:-opencode-adapter}
      - ACGS_AGENT_SECRET=${OPENCODE_AGENT_SECRET}
      
      # Constitutional Hash
      - ACGS_CONSTITUTIONAL_HASH=${ACGS_CONSTITUTIONAL_HASH:-cdd01ef066bc6cf2}
      
      # Service Configuration
      - PORT=8020
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_ENV=${NODE_ENV:-production}
      
      # OpenCode Configuration
      - OPENCODE_BIN_PATH=/usr/local/bin/opencode
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    depends_on:
      auth-service:
        condition: service_healthy
      policy-service:
        condition: service_healthy
      audit-service:
        condition: service_healthy
      hitl-service:
        condition: service_healthy
    
    networks:
      - acgs-network
    
    volumes:
      # Mount for OpenCode cache and configurations
      - opencode-data:/app/.opencode
      # Mount for logs
      - ./logs/opencode-adapter:/app/logs
    
    restart: unless-stopped
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  # Optional: Standalone OpenCode CLI for testing
  opencode-cli:
    image: node:20-alpine
    container_name: acgs-opencode-cli
    command: |
      sh -c "
        npm install -g opencode-ai@latest &&
        tail -f /dev/null
      "
    networks:
      - acgs-network
    volumes:
      - opencode-cli-data:/root/.opencode
    profiles:
      - cli-tools

networks:
  acgs-network:
    external: true
    name: acgs-network

volumes:
  opencode-data:
    driver: local
  opencode-cli-data:
    driver: local