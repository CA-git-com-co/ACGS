name: Fixed Connectivity Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  connectivity-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # OPTION 1: Install ping if needed
    - name: Install network tools (if needed)
      run: |
        if ! command -v ping >/dev/null 2>&1; then
          echo "üì¶ Installing ping..."
          sudo apt-get update -qq
          sudo apt-get install -y iputils-ping
          echo "‚úÖ ping installed"
        else
          echo "‚úÖ ping already available"
        fi
        
    # OPTION 2: Use HTTP-based check (RECOMMENDED)
    - name: GitHub Connectivity Check (HTTP-based)
      run: |
        echo "üåê Testing GitHub connectivity with HTTP..."
        
        # Test GitHub main site
        if curl -s --max-time 10 --head https://github.com >/dev/null 2>&1; then
          echo "‚úÖ GitHub main site accessible"
        else
          echo "‚ùå GitHub main site not accessible"
          exit 1
        fi
        
        # Test GitHub API
        if curl -s --max-time 10 https://api.github.com/zen >/dev/null 2>&1; then
          echo "‚úÖ GitHub API accessible"
        else
          echo "‚ùå GitHub API not accessible"
          exit 1
        fi
        
        echo "üéâ All GitHub connectivity checks passed!"
        
    # OPTION 3: Use our robust script
    - name: Robust Connectivity Check
      run: |
        chmod +x scripts/robust-github-connectivity-check.sh
        ./scripts/robust-github-connectivity-check.sh
        
    # OPTION 4: Traditional ping (after installing)
    # Ping check removed - ICMP traffic is often blocked on GitHub Actions runners
    # Using HTTP-based connectivity checks instead for better reliability
    - name: HTTP Connectivity Check
      run: |
        echo "üì° Testing HTTP connectivity to GitHub..."
        if curl -I https://github.com 2>&1 | grep -q "HTTP"; then
          echo "‚úÖ GitHub HTTP connectivity verified"
        else
          echo "‚ùå GitHub HTTP connectivity failed"
          exit 1
        fi
