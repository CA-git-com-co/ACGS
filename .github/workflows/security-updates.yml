name: Security Updates and Vulnerability Fixes

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of security update'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit pip-audit

      - name: Run pip-audit
        continue-on-error: true
        run: |
          echo "ðŸ” Running pip-audit for vulnerability scanning..."
          pip-audit --desc --fix --dry-run > pip-audit-report.txt || true
          cat pip-audit-report.txt

      - name: Run safety check
        continue-on-error: true
        run: |
          echo "ðŸ” Running safety check..."
          safety check --json > safety-report.json || true
          safety check || true

      - name: Run bandit security scan
        continue-on-error: true
        run: |
          echo "ðŸ” Running bandit security scan..."
          bandit -r services/ -f json -o bandit-report.json || true
          bandit -r services/ || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            pip-audit-report.txt
            safety-report.json
            bandit-report.json

  update-dependencies:
    name: Update Vulnerable Dependencies
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Update critical dependencies
        run: |
          echo "ðŸ“¦ Updating critical security dependencies..."
          
          # Update pip itself
          python -m pip install --upgrade pip
          
          # Install pip-tools for better dependency management
          pip install pip-tools
          
          # Update critical security packages
          pip install --upgrade \
            cryptography \
            pyjwt \
            python-jose \
            passlib \
            python-multipart \
            fastapi \
            uvicorn \
            pydantic \
            httpx
          
          # Generate updated requirements
          pip freeze > requirements-updated.txt

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(deps): update vulnerable dependencies'
          title: '[Security] Update vulnerable dependencies'
          body: |
            ## Security Update
            
            This PR updates dependencies with known security vulnerabilities.
            
            ### Updates included:
            - Critical security patches
            - Dependency version bumps
            - Vulnerability fixes identified by automated scanning
            
            ### Security scan results:
            - See artifacts from the security-scan job
            
            ### Testing required:
            - [ ] Run integration tests
            - [ ] Run E2E tests
            - [ ] Verify service functionality
            
            ---
            Auto-generated by Security Updates workflow
          branch: security-updates-${{ github.run_number }}
          delete-branch: true
          labels: |
            security
            dependencies
            automated