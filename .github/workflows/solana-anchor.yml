name: Solana Anchor Programs CI

on:
  push:
    branches: [ main, master ]
    paths:
      - 'blockchain/**'
      - 'quantumagi_core/**'
      - '.github/workflows/solana-anchor.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'blockchain/**'
      - 'quantumagi_core/**'
      - '.github/workflows/solana-anchor.yml'
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM for comprehensive blockchain testing

permissions:
  contents: read
  security-events: write

env:
  SOLANA_CLI_VERSION: 1.18.22
  ANCHOR_CLI_VERSION: 0.29.0
  NODE_VERSION: '18'
  RUST_TOOLCHAIN: 1.75.0

jobs:
  anchor-test:
    runs-on: ubuntu-latest
    name: Anchor Program Tests
    strategy:
      matrix:
        project: ['blockchain']
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Check if project exists
        id: check_project
        run: |
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/Anchor.toml" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Warning: Project ${{ matrix.project }} does not exist or has no Anchor.toml"
          fi

      - name: Install Rust
        if: steps.check_project.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        if: steps.check_project.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ matrix.project }}/target/
          key: ${{ runner.os }}-cargo-${{ matrix.project }}-${{ hashFiles(format('{0}/**/Cargo.lock', matrix.project)) }}
          restore-keys: ${{ runner.os }}-cargo-${{ matrix.project }}-

      - name: Install Solana CLI
        if: steps.check_project.outputs.exists == 'true'
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_CLI_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      - name: Install Anchor CLI
        if: steps.check_project.outputs.exists == 'true'
        run: |
          npm install -g @coral-xyz/anchor-cli@${{ env.ANCHOR_CLI_VERSION }}
          anchor --version

      - name: Set up Node.js
        if: steps.check_project.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Install Node.js dependencies
        if: steps.check_project.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Rust format check
        if: steps.check_project.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        run: cargo fmt --all -- --check

      - name: Rust clippy
        if: steps.check_project.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build Anchor programs
        if: steps.check_project.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          solana config set --url localhost
          anchor build

      - name: Run Anchor tests
        if: steps.check_project.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          # Start local validator in background
          solana-test-validator --reset --quiet &
          VALIDATOR_PID=$!
          sleep 15
          
          # Wait for validator to be ready
          timeout 30 bash -c 'until solana cluster-version; do sleep 1; done'
          
          # Run tests
          anchor test --skip-local-validator || TEST_RESULT=$?
          
          # Cleanup
          kill $VALIDATOR_PID || true
          
          # Exit with test result
          exit ${TEST_RESULT:-0}

      - name: Upload test results
        if: always() && steps.check_project.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: anchor-test-results-${{ matrix.project }}
          path: |
            ${{ matrix.project }}/target/
            ${{ matrix.project }}/test-ledger/
          retention-days: 7

  security-audit:
    runs-on: ubuntu-latest
    name: Rust Security Audit
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit on blockchain
        if: hashFiles('blockchain/Cargo.lock') != ''
        working-directory: blockchain
        run: cargo audit

      - name: Run security audit on quantumagi_core
        if: hashFiles('quantumagi_core/Cargo.lock') != ''
        working-directory: quantumagi_core
        run: cargo audit

  program-verification:
    runs-on: ubuntu-latest
    name: Program Verification
    needs: anchor-test
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_CLI_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Verify program builds
        run: |
          echo "✅ Solana Anchor program verification completed"
          echo "All programs built successfully and passed tests"

  notify-solana-results:
    runs-on: ubuntu-latest
    name: Notify Solana Results
    needs: [anchor-test, security-audit, program-verification]
    if: always()
    steps:
      - name: Generate Solana test report
        run: |
          echo "# Solana Anchor Programs Test Report" > solana-test-report.md
          echo "Generated: $(date)" >> solana-test-report.md
          echo "Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> solana-test-report.md
          echo "" >> solana-test-report.md
          echo "## Test Results Summary" >> solana-test-report.md
          echo "- Anchor Tests: ${{ needs.anchor-test.result }}" >> solana-test-report.md
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> solana-test-report.md
          echo "- Program Verification: ${{ needs.program-verification.result }}" >> solana-test-report.md

      - name: Upload Solana test report
        uses: actions/upload-artifact@v4
        with:
          name: solana-test-report
          path: solana-test-report.md
          retention-days: 14

      - name: Notify on success
        if: success()
        run: |
          echo "✅ All Solana Anchor tests passed successfully!"
          echo "Programs are ready for deployment to devnet/mainnet"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Some Solana Anchor tests failed. Check the logs for details."
          echo "Review program code and fix issues before deployment"
