# ACGS Kimi-Dev-72B Alert Rules
# Comprehensive monitoring and alerting for the Kimi service

groups:
  - name: kimi-service-health
    rules:
      # Service availability
      - alert: KimiServiceDown
        expr: up{job="kimi-service"} == 0
        for: 1m
        labels:
          severity: critical
          service: kimi-dev-72b
          component: api
        annotations:
          summary: 'Kimi-Dev-72B service is down'
          description: 'The Kimi-Dev-72B service has been down for more than 1 minute'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-service-down'

      # High response time
      - alert: KimiHighResponseTime
        expr: histogram_quantile(0.95, rate(acgs_kimi_http_request_duration_seconds_bucket[5m])) > 10
        for: 2m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: api
        annotations:
          summary: 'Kimi service high response time'
          description: '95th percentile response time is {{ $value }}s for the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-high-latency'

      # High error rate
      - alert: KimiHighErrorRate
        expr: rate(acgs_kimi_http_requests_total{status=~"5.."}[5m]) / rate(acgs_kimi_http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: api
        annotations:
          summary: 'Kimi service high error rate'
          description: 'Error rate is {{ $value | humanizePercentage }} for the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-high-error-rate'

  - name: kimi-resource-usage
    rules:
      # High CPU usage
      - alert: KimiHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{name="acgs_kimi_service"}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: container
        annotations:
          summary: 'Kimi service high CPU usage'
          description: 'CPU usage is {{ $value }}% for the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-high-cpu'

      # High memory usage
      - alert: KimiHighMemoryUsage
        expr: (container_memory_usage_bytes{name="acgs_kimi_service"} / container_spec_memory_limit_bytes{name="acgs_kimi_service"}) * 100 > 85
        for: 3m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: container
        annotations:
          summary: 'Kimi service high memory usage'
          description: 'Memory usage is {{ $value }}% of limit for the last 3 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-high-memory'

      # Container restart
      - alert: KimiContainerRestart
        expr: increase(container_start_time_seconds{name="acgs_kimi_service"}[10m]) > 0
        for: 0m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: container
        annotations:
          summary: 'Kimi container restarted'
          description: 'Kimi container has restarted {{ $value }} times in the last 10 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-container-restart'

  - name: kimi-gpu-monitoring
    rules:
      # GPU memory usage
      - alert: KimiGPUHighMemoryUsage
        expr: (nvidia_ml_py_memory_used_bytes / nvidia_ml_py_memory_total_bytes) * 100 > 90
        for: 2m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: gpu
        annotations:
          summary: 'Kimi GPU high memory usage'
          description: 'GPU memory usage is {{ $value }}% for the last 2 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-gpu-memory'

      # GPU utilization
      - alert: KimiGPULowUtilization
        expr: nvidia_ml_py_utilization_gpu < 10
        for: 10m
        labels:
          severity: info
          service: kimi-dev-72b
          component: gpu
        annotations:
          summary: 'Kimi GPU low utilization'
          description: 'GPU utilization is {{ $value }}% for the last 10 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-gpu-utilization'

      # GPU temperature
      - alert: KimiGPUHighTemperature
        expr: nvidia_ml_py_temperature_gpu > 80
        for: 1m
        labels:
          severity: critical
          service: kimi-dev-72b
          component: gpu
        annotations:
          summary: 'Kimi GPU high temperature'
          description: 'GPU temperature is {{ $value }}Â°C'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-gpu-temperature'

  - name: kimi-model-performance
    rules:
      # Model loading time
      - alert: KimiSlowModelLoading
        expr: acgs_kimi_model_loading_duration_seconds > 300
        for: 0m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: model
        annotations:
          summary: 'Kimi model loading is slow'
          description: 'Model loading took {{ $value }}s'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-slow-loading'

      # Token generation rate
      - alert: KimiLowTokenGenerationRate
        expr: rate(acgs_kimi_tokens_generated_total[5m]) < 10
        for: 5m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: model
        annotations:
          summary: 'Kimi low token generation rate'
          description: 'Token generation rate is {{ $value }} tokens/sec for the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-low-token-rate'

      # Queue length
      - alert: KimiHighQueueLength
        expr: acgs_kimi_request_queue_length > 50
        for: 2m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: queue
        annotations:
          summary: 'Kimi high request queue length'
          description: 'Request queue length is {{ $value }}'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-high-queue'

  - name: kimi-constitutional-compliance
    rules:
      # Constitutional compliance violations
      - alert: KimiConstitutionalViolation
        expr: increase(acgs_kimi_constitutional_violations_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: kimi-dev-72b
          component: governance
        annotations:
          summary: 'Kimi constitutional compliance violation'
          description: '{{ $value }} constitutional violations detected in the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/constitutional-violation'

      # Low compliance score
      - alert: KimiLowComplianceScore
        expr: acgs_kimi_constitutional_compliance_score < 0.95
        for: 1m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: governance
        annotations:
          summary: 'Kimi low constitutional compliance score'
          description: 'Constitutional compliance score is {{ $value }}'
          runbook_url: 'https://docs.acgs.local/runbooks/low-compliance-score'

  - name: kimi-integration-health
    rules:
      # ACGS service integration
      - alert: KimiACGSIntegrationFailure
        expr: increase(acgs_kimi_integration_failures_total[5m]) > 5
        for: 1m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: integration
        annotations:
          summary: 'Kimi ACGS integration failures'
          description: '{{ $value }} integration failures with ACGS services in the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-integration-failure'

      # Authentication failures
      - alert: KimiAuthenticationFailures
        expr: increase(acgs_kimi_auth_failures_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: kimi-dev-72b
          component: auth
        annotations:
          summary: 'Kimi authentication failures'
          description: '{{ $value }} authentication failures in the last 5 minutes'
          runbook_url: 'https://docs.acgs.local/runbooks/kimi-auth-failures'
