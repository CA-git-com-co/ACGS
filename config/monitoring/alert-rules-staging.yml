# ACGS Nano-vLLM Staging Alert Rules
# Constitutional AI Compliance and Performance Monitoring

groups:
  # =============================================================================
  # Constitutional AI Compliance Alerts
  # =============================================================================
  - name: constitutional_ai_compliance
    rules:
      - alert: ConstitutionalComplianceDropped
        expr: constitutional_compliance_score < 0.75
        for: 30s
        labels:
          severity: critical
          component: constitutional-ai
          service: nano-vllm
        annotations:
          summary: 'Constitutional compliance score dropped below threshold'
          description: 'Constitutional compliance score is {{ $value }}, which is below the required threshold of 0.75'
          runbook_url: 'https://docs.acgs.ai/runbooks/constitutional-compliance'

      - alert: ConstitutionalReasoningFailure
        expr: rate(constitutional_reasoning_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: constitutional-ai
          service: nano-vllm
        annotations:
          summary: 'High rate of constitutional reasoning failures'
          description: 'Constitutional reasoning failure rate is {{ $value }} per second over the last 5 minutes'

      - alert: ConstitutionalPrincipleViolation
        expr: constitutional_principle_violations_total > 0
        for: 0s # Immediate alert
        labels:
          severity: critical
          component: constitutional-ai
          service: nano-vllm
        annotations:
          summary: 'Constitutional principle violation detected'
          description: '{{ $value }} constitutional principle violations detected'
          runbook_url: 'https://docs.acgs.ai/runbooks/principle-violations'

  # =============================================================================
  # Performance and Response Time Alerts
  # =============================================================================
  - name: nano_vllm_performance
    rules:
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(nano_vllm_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          component: performance
          service: nano-vllm
        annotations:
          summary: 'High response time detected'
          description: '95th percentile response time is {{ $value }}s, exceeding 2s threshold'

      - alert: VeryHighResponseTime
        expr: histogram_quantile(0.95, rate(nano_vllm_request_duration_seconds_bucket[5m])) > 5
        for: 2m
        labels:
          severity: critical
          component: performance
          service: nano-vllm
        annotations:
          summary: 'Very high response time detected'
          description: '95th percentile response time is {{ $value }}s, exceeding 5s critical threshold'

      - alert: HighConcurrentRequests
        expr: nano_vllm_concurrent_requests > 25
        for: 5m
        labels:
          severity: warning
          component: performance
          service: nano-vllm
        annotations:
          summary: 'High number of concurrent requests'
          description: '{{ $value }} concurrent requests, approaching capacity limits'

  # =============================================================================
  # Service Health and Availability Alerts
  # =============================================================================
  - name: nano_vllm_health
    rules:
      - alert: ServiceDown
        expr: up{job="nano-vllm-constitutional-ai"} == 0
        for: 1m
        labels:
          severity: critical
          component: availability
          service: nano-vllm
        annotations:
          summary: 'Nano-vLLM service is down'
          description: 'Nano-vLLM constitutional AI service has been down for more than 1 minute'
          runbook_url: 'https://docs.acgs.ai/runbooks/service-recovery'

      - alert: HealthCheckFailing
        expr: nano_vllm_health_check_status != 1
        for: 2m
        labels:
          severity: warning
          component: health
          service: nano-vllm
        annotations:
          summary: 'Health check failing'
          description: 'Nano-vLLM health check has been failing for more than 2 minutes'

      - alert: ModelLoadingFailure
        expr: nano_vllm_model_loading_failures_total > 0
        for: 0s
        labels:
          severity: critical
          component: model-loading
          service: nano-vllm
        annotations:
          summary: 'Model loading failure detected'
          description: '{{ $value }} model loading failures detected'

  # =============================================================================
  # Resource Utilization Alerts
  # =============================================================================
  - name: nano_vllm_resources
    rules:
      - alert: HighMemoryUsage
        expr: (nano_vllm_memory_usage_bytes / nano_vllm_memory_limit_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          component: resources
          service: nano-vllm
        annotations:
          summary: 'High memory usage'
          description: 'Memory usage is {{ $value | humanizePercentage }}, approaching limits'

      - alert: HighCPUUsage
        expr: rate(nano_vllm_cpu_usage_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          component: resources
          service: nano-vllm
        annotations:
          summary: 'High CPU usage'
          description: 'CPU usage is {{ $value | humanizePercentage }} over the last 5 minutes'

      - alert: GPUMemoryHigh
        expr: (nano_vllm_gpu_memory_used_bytes / nano_vllm_gpu_memory_total_bytes) > 0.95
        for: 5m
        labels:
          severity: warning
          component: gpu
          service: nano-vllm
        annotations:
          summary: 'High GPU memory usage'
          description: 'GPU memory usage is {{ $value | humanizePercentage }}'

  # =============================================================================
  # Error Rate and Quality Alerts
  # =============================================================================
  - name: nano_vllm_errors
    rules:
      - alert: HighErrorRate
        expr: rate(nano_vllm_requests_total{status=~"5.."}[5m]) / rate(nano_vllm_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: errors
          service: nano-vllm
        annotations:
          summary: 'High error rate'
          description: 'Error rate is {{ $value | humanizePercentage }} over the last 5 minutes'

      - alert: CriticalErrorRate
        expr: rate(nano_vllm_requests_total{status=~"5.."}[5m]) / rate(nano_vllm_requests_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          component: errors
          service: nano-vllm
        annotations:
          summary: 'Critical error rate'
          description: 'Error rate is {{ $value | humanizePercentage }}, exceeding critical threshold'

      - alert: ReasoningQualityDegraded
        expr: avg_over_time(nano_vllm_reasoning_quality_score[10m]) < 0.8
        for: 5m
        labels:
          severity: warning
          component: quality
          service: nano-vllm
        annotations:
          summary: 'Reasoning quality degraded'
          description: 'Average reasoning quality score is {{ $value }}, below acceptable threshold'

  # =============================================================================
  # Load Testing Alerts
  # =============================================================================
  - name: load_testing
    rules:
      - alert: LoadTestFailureRate
        expr: rate(load_test_failures_total[5m]) > 0.02
        for: 2m
        labels:
          severity: warning
          component: load-testing
          service: nano-vllm
        annotations:
          summary: 'High load test failure rate'
          description: 'Load test failure rate is {{ $value }} per second'

      - alert: LoadTestResponseTimeDegraded
        expr: histogram_quantile(0.95, rate(load_test_request_duration_seconds_bucket[5m])) > 3
        for: 5m
        labels:
          severity: warning
          component: load-testing
          service: nano-vllm
        annotations:
          summary: 'Load test response time degraded'
          description: '95th percentile load test response time is {{ $value }}s'
