# Multi-Level Caching Configuration for ACGS-PGP
# Phase 2 Implementation - Sub-2s Response Time Guarantee
#
# Expected Outcomes:
# - 50-70% query complexity reduction
# - Sub-2s response time guarantee
# - Improved cache hit rates
# - Enhanced constitutional validation performance
# - Maintained constitutional compliance >95%

multi_level_cache:
  # Global Cache Settings
  enabled: true
  constitutional_hash: "cdd01ef066bc6cf2"
  
  # Performance Targets
  performance_targets:
    response_time_max_ms: 2000          # Sub-2s guarantee
    constitutional_compliance_min: 0.95  # >95% compliance
    cache_hit_rate_target: 0.80         # 80% cache hit rate target
    query_complexity_reduction: 0.60    # 60% complexity reduction
  
  # L1 Memory Cache Configuration
  l1_memory_cache:
    enabled: true
    max_size_kb: 64                     # 64KB per core
    access_time_target_ns: 1            # <1ns access time
    ttl_seconds: 3600                   # 1 hour default TTL
    eviction_policy: "lru"              # Least Recently Used
    
    # High confidence rules get longer TTL
    ttl_by_confidence:
      high: 3600      # confidence >= 0.95
      medium: 1800    # confidence >= 0.90
      low: 900        # confidence < 0.90
  
  # L2 Process Cache Configuration  
  l2_process_cache:
    enabled: true
    max_size_kb: 512                    # 512KB capacity
    access_time_target_ns: 5            # ~5ns access time
    ttl_seconds: 7200                   # 2 hours default TTL
    rule_compilation_enabled: true
    
    # Compiled rule settings
    compiled_rules:
      max_execution_time_ms: 1          # Max 1ms execution time
      cache_compiled_results: true
      optimization_level: "high"
  
  # L3 Redis Distributed Cache Configuration
  l3_redis_cache:
    enabled: true
    redis_url: "redis://localhost:6379/1"
    connection_pool_size: 10
    timeout_seconds: 5
    ttl_seconds: 86400                  # 24 hours default TTL
    
    # Redis-specific settings
    redis_settings:
      max_connections: 20
      retry_on_timeout: true
      socket_keepalive: true
      socket_keepalive_options: {}
      health_check_interval: 30
  
  # Bloom Filter Configuration
  bloom_filter:
    enabled: true
    capacity: 1000000                   # 1M items capacity
    error_rate: 0.001                   # 0.1% false positive rate
    hash_functions: 10                  # Optimal hash function count
    
    # Pre-populated violation patterns
    violation_patterns:
      - "violence"
      - "discrimination" 
      - "illegal"
      - "harmful"
      - "unethical"
      - "dangerous"
      - "inappropriate"
      - "bias"
      - "hate"
      - "threat"
      - "weapon"
      - "drug"
      - "explicit"

# Parallel Validation Pipeline Configuration
parallel_validation:
  enabled: true
  
  # Validation Stages
  stages:
    syntax_validation:
      enabled: true
      timeout_ms: 100
      circuit_breaker:
        failure_threshold: 50
        recovery_timeout: 30
    
    semantic_validation:
      enabled: true
      timeout_ms: 200
      circuit_breaker:
        failure_threshold: 50
        recovery_timeout: 30
    
    constitutional_validation:
      enabled: true
      timeout_ms: 1500                  # Allows for cache lookup + validation
      circuit_breaker:
        failure_threshold: 100
        recovery_timeout: 30
  
  # Aggregation Settings
  aggregation:
    confidence_weighting: true
    minimum_confidence: 0.70
    require_all_stages: true
    
  # Performance Monitoring
  monitoring:
    track_stage_performance: true
    log_slow_validations: true
    slow_validation_threshold_ms: 1000

# Cache Integration Configuration
cache_integration:
  # ACGS-PGP Service Integration
  services:
    ac_service:
      endpoint: "http://localhost:8001"
      cache_enabled: true
      timeout_seconds: 30
      health_check_path: "/health"
      
    pgc_service:
      endpoint: "http://localhost:8005"
      cache_enabled: true
      timeout_seconds: 30
      health_check_path: "/health"
      
    integrity_service:
      endpoint: "http://localhost:8002"
      cache_enabled: true
      timeout_seconds: 30
      health_check_path: "/health"
      
    fv_service:
      endpoint: "http://localhost:8003"
      cache_enabled: true
      timeout_seconds: 30
      health_check_path: "/health"
  
  # Fallback Behavior
  fallback:
    on_cache_miss: "service_call"       # service_call, default_compliant, error
    on_service_unavailable: "default_compliant"
    on_timeout: "default_compliant"
    default_compliance_result: true
  
  # Request Routing
  routing:
    cache_first: true
    parallel_cache_service: false       # Set to true for A/B testing
    cache_write_through: true

# Performance Optimization
performance:
  # Cache Warming
  cache_warming:
    enabled: true
    warm_on_startup: true
    common_requests_file: "config/cache-warming-requests.json"
    warming_concurrency: 10
  
  # Prefetching
  prefetching:
    enabled: false                      # Disabled initially
    prediction_model: "lru_based"
    prefetch_threshold: 0.80
    max_prefetch_items: 100
  
  # Compression
  compression:
    enabled: true
    algorithm: "lz4"                    # Fast compression
    min_size_bytes: 1024               # Only compress larger entries
  
  # Memory Management
  memory_management:
    gc_interval_seconds: 300           # 5 minutes
    memory_pressure_threshold: 0.85
    emergency_eviction_enabled: true

# Monitoring and Metrics
monitoring:
  # Metrics Collection
  metrics:
    enabled: true
    collection_interval_seconds: 30
    retention_days: 30
    export_prometheus: true
    
    # Key Performance Indicators
    kpis:
      - cache_hit_rate
      - average_response_time
      - constitutional_compliance_rate
      - error_rate
      - memory_utilization
      - query_complexity_reduction
  
  # Alerting
  alerting:
    enabled: true
    
    # Alert Thresholds
    thresholds:
      critical:
        response_time_ms: 5000
        constitutional_compliance: 0.75
        cache_hit_rate: 0.30
        error_rate: 0.10
        
      high:
        response_time_ms: 2000
        constitutional_compliance: 0.90
        cache_hit_rate: 0.50
        error_rate: 0.05
        
      moderate:
        response_time_ms: 1500
        constitutional_compliance: 0.95
        cache_hit_rate: 0.70
        error_rate: 0.02
  
  # Health Checks
  health_checks:
    enabled: true
    interval_seconds: 60
    timeout_seconds: 10
    
    checks:
      - cache_connectivity
      - redis_connectivity
      - service_connectivity
      - constitutional_hash_integrity
      - memory_usage
      - performance_targets

# Security and Compliance
security:
  # Data Protection
  data_protection:
    encrypt_cache_entries: false       # Enable for sensitive data
    hash_cache_keys: true
    sanitize_logs: true
    
  # Access Control
  access_control:
    require_authentication: false      # Internal service communication
    rate_limiting: true
    rate_limit_requests_per_minute: 10000
  
  # Audit
  audit:
    log_cache_operations: true
    log_constitutional_validations: true
    audit_retention_days: 90
    
# Environment-Specific Overrides
environments:
  development:
    l1_memory_cache:
      max_size_kb: 32                  # Smaller cache for dev
    l2_process_cache:
      max_size_kb: 256
    bloom_filter:
      capacity: 100000
    monitoring:
      collection_interval_seconds: 60
      
  staging:
    performance_targets:
      response_time_max_ms: 1500       # Stricter targets for staging
    cache_warming:
      enabled: true
    monitoring:
      alerting:
        enabled: true
        
  production:
    performance_targets:
      response_time_max_ms: 2000
      constitutional_compliance_min: 0.95
      cache_hit_rate_target: 0.85
    
    l3_redis_cache:
      redis_url: "redis://redis-cluster:6379/1"
      connection_pool_size: 20
      
    monitoring:
      metrics:
        export_prometheus: true
      alerting:
        enabled: true
        
    security:
      data_protection:
        encrypt_cache_entries: true
      audit:
        log_cache_operations: true

# Integration with Existing Systems
integration:
  # DeepSeek R1 Pilot Integration
  deepseek_r1_pilot:
    cache_deepseek_responses: true
    separate_cache_namespace: true
    cache_ttl_seconds: 3600
    
  # Constitutional AI Integration
  constitutional_ai:
    hash_verification: "cdd01ef066bc6cf2"
    compliance_caching: true
    violation_pattern_learning: true
    
  # DGM Safety Patterns
  dgm_safety:
    preserve_safety_patterns: true
    cache_safety_validations: true
    emergency_cache_clear: true
    human_review_integration: true
    
  # Resource Limits (ACGS-PGP Standard)
  resource_limits:
    cpu_request: "200m"
    cpu_limit: "500m"
    memory_request: "512Mi"
    memory_limit: "1Gi"
    
    # Cache-specific limits
    cache_memory_limit: "256Mi"        # Subset of total memory
    redis_memory_limit: "128Mi"
